{% extends 'accounts/home.html' %}
{% load static %}

{% block content %}
<style>
    /* Estilos personalizados para mejorar la experiencia visual */
    .page-header {
        background: linear-gradient(135deg, #1a3c5e 0%, #2d5a8a 100%);
        color: white;
        padding: 2rem 0;
        margin: -1rem -15px 2rem -15px;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.3;
    }
    
    .page-header .container {
        position: relative;
        z-index: 1;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .breadcrumb-nav {
        background: rgba(255,255,255,0.1);
        border-radius: 25px;
        padding: 0.5rem 1rem;
        backdrop-filter: blur(10px);
    }
    
    .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--card-gradient);
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    
    .stats-card.card-info { --card-gradient: linear-gradient(90deg, #17a2b8, #20c997); }
    .stats-card.card-warning { --card-gradient: linear-gradient(90deg, #ffc107, #fd7e14); }
    .stats-card.card-success { --card-gradient: linear-gradient(90deg, #28a745, #20c997); }
    
    .card-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .card-number {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .filter-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.06);
        margin-bottom: 2rem;
    }
    
    .filter-header {
        background: linear-gradient(90deg, #f8f9fa, #e9ecef);
        border-radius: 15px 15px 0 0;
        padding: 1.25rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #1a3c5e;
        box-shadow: 0 0 0 0.2rem rgba(26, 60, 94, 0.15);
    }
    
    .btn {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #1a3c5e, #2d5a8a);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 60, 94, 0.3);
    }
    
    .btn-outline-secondary {
        border: 2px solid #6c757d;
    }
    
    .btn-outline-secondary:hover {
        transform: translateY(-2px);
    }
    
    .main-table-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .table-header {
        background: linear-gradient(90deg, #1a3c5e, #2d5a8a);
        color: white;
        padding: 1.5rem;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        background-color: #343a40;
        color: white;
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .estado-vencido { 
        background: linear-gradient(45deg, #dc3545, #c82333);
        color: white;
    }
    
    .estado-critico { 
        background: linear-gradient(45deg, #fd7e14, #e8590c);
        color: white;
    }
    
    .estado-proximo { 
        background: linear-gradient(45deg, #ffc107, #e0a800);
        color: #000;
    }
    
    .estado-bueno { 
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
    }
    
    .btn-group .btn {
        margin-right: 0.25rem;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
    
    .pagination {
        justify-content: center;
        margin-top: 2rem;
    }
    
    .page-link {
        border-radius: 8px;
        margin: 0 2px;
        border: 1px solid #dee2e6;
        color: #1a3c5e;
    }
    
    .page-item.active .page-link {
        background: linear-gradient(45deg, #1a3c5e, #2d5a8a);
        border-color: #1a3c5e;
    }
    
    .page-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(26, 60, 94, 0.2);
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        border-radius: 15px 15px 0 0;
        border-bottom: 1px solid #dee2e6;
        padding: 1.5rem;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
        padding: 1rem 1.5rem;
    }
    
    /* Animaciones */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Animaciones más suaves y menos disruptivas */
    .fade-in-up {
        animation: fadeInUpSmooth 0.4s ease-out;
        animation-fill-mode: both;
    }
    
    @keyframes fadeInUpSmooth {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Transiciones mínimas para cambios de página - sin scroll forzado */
    .page-transition {
        transition: opacity 0.1s ease-in-out;
    }
    
    .page-fade-out {
        opacity: 0.95; /* Casi imperceptible */
    }
    
    .page-fade-in {
        opacity: 1;
    }
    
    /* Animaciones para cards de lotes */
    .lote-card {
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(20px);
    }
    
    .lote-card.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .lote-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    /* Gradiente para headers de cards de lotes */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    .pulse-animation {
        animation: pulse 3s infinite;
    }
</style>

<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Gestión de Vencimientos
                </h1>
                <p class="page-subtitle">
                    Administra fechas de vencimiento y controla lotes de productos
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="breadcrumb-nav">
                    <a href="{% url 'control-vencimientos' %}" class="btn btn-light btn-sm me-2">
                        <i class="fas fa-arrow-left"></i> Control
                    </a>
                    <a href="{% url 'home' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-home"></i> Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <!-- Mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show text-center fade-in-up" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Estadísticas mejoradas -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3 fade-in-up" style="animation-delay: 0.1s;">
            <div class="card stats-card card-info text-center">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="card-number">{{ total_productos }}</div>
                    <div class="card-text">Total Productos</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 fade-in-up" style="animation-delay: 0.2s;">
            <div class="card stats-card card-warning text-center">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-number">{{ productos_sin_vencimiento }}</div>
                    <div class="card-text">Sin Vencimiento</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 fade-in-up" style="animation-delay: 0.3s;">
            <div class="card stats-card card-success text-center">
                <div class="card-body">
                    <div class="card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-number">{{ productos_con_vencimiento }}</div>
                    <div class="card-text">Con Vencimiento</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros mejorados -->
    <div class="card filter-card fade-in-up" style="animation-delay: 0.4s;">
        <div class="filter-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filtros de Búsqueda
            </h5>
        </div>
        <div class="card-body">
            <form method="get" id="filter-form">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="codigo_barra" class="form-label fw-bold">
                            <i class="fas fa-barcode me-1"></i>
                            Código de Barra
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="codigo_barra" 
                               name="codigo_barra" 
                               value="{{ query_codigo }}" 
                               placeholder="Ej: 123456789">
                    </div>
                    <div class="col-md-3">
                        <label for="descripcion" class="form-label fw-bold">
                            <i class="fas fa-tag me-1"></i>
                            Descripción
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="descripcion" 
                               name="descripcion" 
                               value="{{ query_descripcion }}" 
                               placeholder="Buscar producto...">
                    </div>
                    <div class="col-md-3">
                        <label for="categoria" class="form-label fw-bold">
                            <i class="fas fa-layer-group me-1"></i>
                            Categoría
                        </label>
                        <select class="form-select" id="categoria" name="categoria">
                            <option value="">Todas las categorías</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.nombre }}" {% if query_categoria == cat.nombre %}selected{% endif %}>
                                    {{ cat.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo" class="form-label fw-bold">
                            <i class="fas fa-filter me-1"></i>
                            Tipo de Producto
                        </label>
                        <select class="form-select" id="tipo" name="tipo">
                            <option value="todos" {% if tipo_filtro == 'todos' %}selected{% endif %}>Todos</option>
                            <option value="sin_vencimiento" {% if tipo_filtro == 'sin_vencimiento' %}selected{% endif %}>Sin Vencimiento</option>
                            <option value="con_vencimiento" {% if tipo_filtro == 'con_vencimiento' %}selected{% endif %}>Con Vencimiento</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-primary me-3">
                            <i class="fas fa-search me-2"></i>
                            Buscar Productos
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="limpiar-filtros">
                            <i class="fas fa-eraser me-2"></i>
                            Limpiar Filtros
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla principal mejorada -->
    <div class="card main-table-card fade-in-up" style="animation-delay: 0.5s;">
        <div class="table-header">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Productos para Gestión de Vencimientos
                {% if page_obj %}
                    <span class="badge bg-light text-dark ms-2">
                        {{ page_obj.paginator.count }} productos
                    </span>
                {% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            {% if page_obj %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-barcode me-1"></i> Código</th>
                                <th><i class="fas fa-tag me-1"></i> Descripción</th>
                                <th><i class="fas fa-layer-group me-1"></i> Categoría</th>
                                <th><i class="fas fa-cubes me-1"></i> Stock</th>
                                <th><i class="fas fa-traffic-light me-1"></i> Estado</th>
                                <th><i class="fas fa-calendar me-1"></i> Fecha Vencimiento</th>
                                <th><i class="fas fa-boxes me-1"></i> Lotes</th>
                                <th><i class="fas fa-cogs me-1"></i> Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in page_obj %}
                            <tr id="producto-{{ item.producto.codigo_barra }}" 
                                data-codigo="{{ item.producto.codigo_barra }}"
                                class="fade-in-up">
                                <td>
                                    <code class="bg-light p-2 rounded">{{ item.producto.codigo_barra }}</code>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ item.producto.descripcion }}</div>
                                </td>
                                <td>
                                    {% if item.producto.categoria %}
                                        <span class="badge bg-info text-white">
                                            <i class="fas fa-folder me-1"></i>
                                            {{ item.producto.categoria.nombre }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-question me-1"></i>
                                            Sin categoría
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge fs-6 {% if item.producto.stock == 0 %}bg-danger{% elif item.producto.stock <= 10 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        <i class="fas fa-cubes me-1"></i>
                                        {{ item.producto.stock }}
                                    </span>
                                </td>
                                <td>
                                    {% if item.producto.tiene_vencimiento %}
                                        <span class="badge estado-{{ item.estado_vencimiento|lower }}">
                                            {% if item.estado_vencimiento == 'Vencido' %}
                                                <i class="fas fa-times-circle me-1"></i>
                                            {% elif item.estado_vencimiento == 'Crítico' %}
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                            {% elif item.estado_vencimiento == 'Precaución' %}
                                                <i class="fas fa-clock me-1"></i>
                                            {% else %}
                                                <i class="fas fa-check-circle me-1"></i>
                                            {% endif %}
                                            {{ item.estado_vencimiento }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-infinity me-1"></i>
                                            Sin Vencimiento
                                        </span>
                                    {% endif %}
                                </td>
                                <td id="fecha-{{ item.producto.codigo_barra }}">
                                    {% if item.producto.tiene_vencimiento %}
                                        {% if item.proximo_vencimiento %}
                                            <span class="fw-bold">
                                                <i class="fas fa-calendar-day me-1"></i>
                                                {{ item.proximo_vencimiento|date:"d/m/Y" }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-question-circle me-1"></i>
                                                Sin fecha
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-minus"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td id="lotes-{{ item.producto.codigo_barra }}">
                                    {% if item.producto.tiene_vencimiento %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-layer-group me-1"></i>
                                            {{ item.total_lotes }} lote{{ item.total_lotes|pluralize:"s" }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-minus"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if not item.producto.tiene_vencimiento %}
                                            <!-- Botón para agregar vencimiento -->
                                            <button type="button" class="btn btn-success btn-sm" 
                                                    data-toggle="modal" data-target="#modalAgregarVencimiento"
                                                    data-codigo="{{ item.producto.codigo_barra }}"
                                                    data-descripcion="{{ item.producto.descripcion }}"
                                                    title="Agregar fecha de vencimiento">
                                                <i class="fas fa-plus me-1"></i> Agregar
                                            </button>
                                        {% else %}
                                            {% if item.total_lotes == 0 %}
                                                <!-- Si no tiene lotes activos, mostrar botón AGREGAR (como si fuera nuevo) -->
                                                <button type="button" class="btn btn-success btn-sm" 
                                                        data-toggle="modal" data-target="#modalAgregarVencimiento"
                                                        data-codigo="{{ item.producto.codigo_barra }}"
                                                        data-descripcion="{{ item.producto.descripcion }}"
                                                        title="Agregar fecha de vencimiento">
                                                    <i class="fas fa-plus me-1"></i> Agregar
                                                </button>
                                            {% else %}
                                                <!-- Si tiene lotes activos, mostrar mensaje informativo -->
                                                <span class="badge bg-info text-dark">
                                                    <i class="fas fa-info-circle me-1"></i> 
                                                    Modificar por lotes
                                                </span>
                                            {% endif %}
                                            <!-- Botón para gestionar lotes (solo si tiene lotes activos) -->
                                            {% if item.total_lotes > 0 %}
                                                <button type="button" class="btn btn-info btn-sm" 
                                                        data-toggle="modal" data-target="#modalGestionarLotes"
                                                        data-codigo="{{ item.producto.codigo_barra }}"
                                                        data-descripcion="{{ item.producto.descripcion }}"
                                                        title="Gestionar lotes del producto">
                                                    <i class="fas fa-layer-group me-1"></i> 
                                                    Lotes ({{ item.total_lotes }})
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación mejorada -->
                {% if page_obj.has_other_pages %}
                    <div class="d-flex justify-content-center mt-4 mb-3">
                        <nav aria-label="Paginación de productos">
                            <ul class="pagination pagination-lg">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if query_codigo %}&codigo_barra={{ query_codigo }}{% endif %}{% if query_descripcion %}&descripcion={{ query_descripcion }}{% endif %}{% if query_categoria %}&categoria={{ query_categoria }}{% endif %}{% if tipo_filtro != 'todos' %}&tipo={{ tipo_filtro }}{% endif %}" title="Primera página">
                                            <i class="fas fa-angle-double-left"></i>
                                            <span class="d-none d-sm-inline ms-1">Primera</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query_codigo %}&codigo_barra={{ query_codigo }}{% endif %}{% if query_descripcion %}&descripcion={{ query_descripcion }}{% endif %}{% if query_categoria %}&categoria={{ query_categoria }}{% endif %}{% if tipo_filtro != 'todos' %}&tipo={{ tipo_filtro }}{% endif %}" title="Página anterior">
                                            <i class="fas fa-angle-left"></i>
                                            <span class="d-none d-sm-inline ms-1">Anterior</span>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">
                                                {{ num }}
                                                <span class="sr-only">(actual)</span>
                                            </span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}{% if query_codigo %}&codigo_barra={{ query_codigo }}{% endif %}{% if query_descripcion %}&descripcion={{ query_descripcion }}{% endif %}{% if query_categoria %}&categoria={{ query_categoria }}{% endif %}{% if tipo_filtro != 'todos' %}&tipo={{ tipo_filtro }}{% endif %}">
                                                {{ num }}
                                            </a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query_codigo %}&codigo_barra={{ query_codigo }}{% endif %}{% if query_descripcion %}&descripcion={{ query_descripcion }}{% endif %}{% if query_categoria %}&categoria={{ query_categoria }}{% endif %}{% if tipo_filtro != 'todos' %}&tipo={{ tipo_filtro }}{% endif %}" title="Página siguiente">
                                            <span class="d-none d-sm-inline me-1">Siguiente</span>
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query_codigo %}&codigo_barra={{ query_codigo }}{% endif %}{% if query_descripcion %}&descripcion={{ query_descripcion }}{% endif %}{% if query_categoria %}&categoria={{ query_categoria }}{% endif %}{% if tipo_filtro != 'todos' %}&tipo={{ tipo_filtro }}{% endif %}" title="Última página">
                                            <span class="d-none d-sm-inline me-1">Última</span>
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    <div class="text-center text-muted mb-3">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} 
                            ({{ page_obj.paginator.count }} productos en total)
                        </small>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-search fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No se encontraron productos</h4>
                    <p class="text-muted mb-4">
                        No hay productos que coincidan con los filtros aplicados.<br>
                        Intenta ajustar los criterios de búsqueda.
                    </p>
                    <button type="button" class="btn btn-outline-primary" id="limpiar-filtros-vacio">
                        <i class="fas fa-eraser me-2"></i>
                        Limpiar Filtros
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modales mejorados -->

<!-- Modal para Agregar Vencimiento -->
<div class="modal fade" id="modalAgregarVencimiento" tabindex="-1" role="dialog" aria-labelledby="modalAgregarVencimientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalAgregarVencimientoLabel">
                    <i class="fas fa-plus-circle me-2"></i> 
                    Agregar Fecha de Vencimiento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Cerrar" 
                        style="font-size: 1.2rem; opacity: 0.85; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); 
                               border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
                               transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
                        onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1.05)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15)';" 
                        onmouseout="this.style.opacity='0.85'; this.style.background='rgba(255,255,255,0.15)'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-times" style="color: white; font-size: 12px; font-weight: 600;"></i>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="formAgregarVencimiento">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-box me-2 text-primary"></i>
                            Producto:
                        </label>
                        <div class="bg-light p-3 rounded">
                            <p id="productoAgregar" class="mb-0 fw-bold text-dark"></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="fechaVencimientoAgregar" class="form-label fw-bold">
                            <i class="fas fa-calendar-alt me-2 text-success"></i>
                            Fecha de Vencimiento:
                        </label>
                        <input type="date" class="form-control form-control-lg" id="fechaVencimientoAgregar" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            La fecha debe ser posterior a hoy
                        </div>
                    </div>
                    <input type="hidden" id="codigoBarraAgregar">
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnAgregarVencimiento">
                    <i class="fas fa-save me-2"></i> 
                    Agregar Vencimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Modificar Vencimiento del Producto -->
<div class="modal fade" id="modalModificarProducto" tabindex="-1" role="dialog" aria-labelledby="modalModificarProductoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalModificarProductoLabel">
                    <i class="fas fa-edit me-2"></i> 
                    Modificar Fecha de Vencimiento
                </h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Cerrar" 
                        style="font-size: 1.2rem; opacity: 0.7; background: rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.15); 
                               border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
                               transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.08);" 
                        onmouseover="this.style.opacity='0.9'; this.style.background='rgba(0,0,0,0.15)'; this.style.transform='scale(1.05)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.12)';" 
                        onmouseout="this.style.opacity='0.7'; this.style.background='rgba(0,0,0,0.08)'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.08)';">
                    <i class="fas fa-times" style="color: #495057; font-size: 12px; font-weight: 600;"></i>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="formModificarProducto">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-box me-2 text-primary"></i>
                            Producto:
                        </label>
                        <div class="bg-light p-3 rounded">
                            <p id="productoModificar" class="mb-0 fw-bold text-dark"></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="fechaVencimientoModificar" class="form-label fw-bold">
                            <i class="fas fa-calendar-alt me-2 text-warning"></i>
                            Nueva Fecha de Vencimiento:
                        </label>
                        <input type="date" class="form-control form-control-lg" id="fechaVencimientoModificar" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            La fecha debe ser posterior a hoy
                        </div>
                    </div>
                    <input type="hidden" id="codigoBarraModificar">
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnModificarProducto">
                    <i class="fas fa-save me-2"></i> 
                    Modificar Vencimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestionar Lotes -->
<div class="modal fade" id="modalGestionarLotes" tabindex="-1" role="dialog" aria-labelledby="modalGestionarLotesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalGestionarLotesLabel">
                    <i class="fas fa-layer-group me-2"></i> 
                    Gestión de Lotes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Cerrar" 
                        style="font-size: 1.2rem; opacity: 0.85; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); 
                               border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
                               transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
                        onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1.05)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15)';" 
                        onmouseout="this.style.opacity='0.85'; this.style.background='rgba(255,255,255,0.15)'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-times" style="color: white; font-size: 12px; font-weight: 600;"></i>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-box me-2 text-primary"></i>
                        Producto:
                    </label>
                    <div class="bg-light p-3 rounded">
                        <p id="productoLotes" class="mb-0 fw-bold text-dark"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-list me-2 text-info"></i>
                            Lotes del Producto
                        </h6>
                        <div id="listaLotes">
                            <!-- Los lotes se cargarán aquí dinámicamente -->
                        </div>
                    </div>
                </div>
                <input type="hidden" id="codigoBarraLotes">
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Modificar Vencimiento de Lote -->
<div class="modal fade" id="modalModificarLote" tabindex="-1" role="dialog" aria-labelledby="modalModificarLoteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalModificarLoteLabel">
                    <i class="fas fa-edit me-2"></i> 
                    Modificar Vencimiento del Lote
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Cerrar" 
                        style="font-size: 1.2rem; opacity: 0.85; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); 
                               border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
                               transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
                        onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1.05)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15)';" 
                        onmouseout="this.style.opacity='0.85'; this.style.background='rgba(255,255,255,0.15)'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                    <i class="fas fa-times" style="color: white; font-size: 12px; font-weight: 600;"></i>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="formModificarLote">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-tags me-2 text-primary"></i>
                            Lote:
                        </label>
                        <div class="bg-light p-3 rounded">
                            <p id="loteModificar" class="mb-0 fw-bold text-dark"></p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="fechaVencimientoLote" class="form-label fw-bold">
                            <i class="fas fa-calendar-alt me-2 text-info"></i>
                            Nueva Fecha de Vencimiento:
                        </label>
                        <input type="date" class="form-control form-control-lg" id="fechaVencimientoLote" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            La fecha debe ser posterior a hoy
                        </div>
                    </div>
                    <input type="hidden" id="codigoBarraLote">
                    <input type="hidden" id="numeroLoteModificar">
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-info" id="btnModificarLote">
                    <i class="fas fa-save me-2"></i> 
                    Modificar Lote
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS -->
<style>
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .card-header {
        background: linear-gradient(135deg, #1a3c5e 0%, #2a4d73 100%);
        color: white;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        font-weight: 600;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table-dark th {
        background-color: #1a3c5e;
        border-color: #2a4d73;
    }
    
    .badge {
        font-size: 0.85em;
    }
    
    .estado-vencido {
        background-color: #dc3545;
    }
    
    .estado-critico {
        background-color: #fd7e14;
    }
    
    .estado-proximo {
        background-color: #ffc107;
        color: #212529;
    }
    
    .estado-bueno {
        background-color: #28a745;
    }
    
    .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    .form-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #1a3c5e;
        box-shadow: 0 0 0 0.2rem rgba(26, 60, 94, 0.25);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #1a3c5e 0%, #2a4d73 100%);
        color: white;
        border-bottom: none;
    }
    
    .modal-header .close {
        color: white;
        opacity: 0.8;
    }
    
    .modal-header .close:hover {
        opacity: 1;
    }
</style>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar fecha mínima como mañana
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const minDate = tomorrow.toISOString().split('T')[0];
        
        const fechaInputs = ['fechaVencimientoAgregar', 'fechaVencimientoModificar', 'fechaVencimientoLote'];
        fechaInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.min = minDate;
            }
        });

        // Limpiar filtros (botón principal)
        document.getElementById('limpiar-filtros').addEventListener('click', function() {
            document.getElementById('codigo_barra').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('tipo').value = 'todos';
            document.getElementById('filter-form').submit();
        });

        // Limpiar filtros (botón de página vacía)
        const btnLimpiarVacio = document.getElementById('limpiar-filtros-vacio');
        if (btnLimpiarVacio) {
            btnLimpiarVacio.addEventListener('click', function() {
                window.location.href = "{% url 'agregar-vencimiento' %}";
            });
        }

        // Modal Agregar Vencimiento
        $('#modalAgregarVencimiento').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            const codigo = button.data('codigo');
            const descripcion = button.data('descripcion');
            
            $('#codigoBarraAgregar').val(codigo);
            $('#productoAgregar').text(codigo + ' - ' + descripcion);
            $('#fechaVencimientoAgregar').val('');
        });

        // Modal Modificar Producto
        $('#modalModificarProducto').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            const codigo = button.data('codigo');
            const descripcion = button.data('descripcion');
            const fecha = button.data('fecha');
            
            $('#codigoBarraModificar').val(codigo);
            $('#productoModificar').text(codigo + ' - ' + descripcion);
            $('#fechaVencimientoModificar').val(fecha);
        });

        // Modal Gestionar Lotes
        $('#modalGestionarLotes').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            const codigo = button.data('codigo');
            const descripcion = button.data('descripcion');
            
            $('#codigoBarraLotes').val(codigo);
            $('#productoLotes').text(codigo + ' - ' + descripcion);
            cargarLotes(codigo);
        });

        // Botón Agregar Vencimiento
        document.getElementById('btnAgregarVencimiento').addEventListener('click', function() {
            const codigo = document.getElementById('codigoBarraAgregar').value;
            const fecha = document.getElementById('fechaVencimientoAgregar').value;
            
            if (!fecha) {
                Swal.fire('Error', 'Por favor selecciona una fecha de vencimiento.', 'error');
                return;
            }
            
            agregarVencimiento(codigo, fecha);
        });

        // Botón Modificar Producto
        document.getElementById('btnModificarProducto').addEventListener('click', function() {
            const codigo = document.getElementById('codigoBarraModificar').value;
            const fecha = document.getElementById('fechaVencimientoModificar').value;
            
            if (!fecha) {
                Swal.fire('Error', 'Por favor selecciona una fecha de vencimiento.', 'error');
                return;
            }
            
            modificarVencimientoProducto(codigo, fecha);
        });

        // Botón Modificar Lote
        document.getElementById('btnModificarLote').addEventListener('click', function() {
            const codigo = document.getElementById('codigoBarraLote').value;
            const numeroLote = document.getElementById('numeroLoteModificar').value;
            const fecha = document.getElementById('fechaVencimientoLote').value;
            
            if (!fecha) {
                Swal.fire('Error', 'Por favor selecciona una fecha de vencimiento.', 'error');
                return;
            }
            
            modificarVencimientoLote(codigo, numeroLote, fecha);
        });
    });

    // Efectos visuales mejorados para UX
    document.addEventListener('DOMContentLoaded', function() {
        // Añadir efectos hover a las estadísticas
        const statsCards = document.querySelectorAll('.stats-card');
        statsCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px) scale(1.02)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Efectos de focus en campos de formulario
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.transform = 'scale(1.02)';
                this.style.boxShadow = '0 0 15px rgba(26, 60, 94, 0.3)';
            });
            input.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '';
            });
        });

        // Añadir tooltips dinámicos a badges
        const badges = document.querySelectorAll('.badge');
        badges.forEach(badge => {
            badge.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
                this.style.zIndex = '1000';
            });
            badge.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.zIndex = '';
            });
        });

        // Eliminado scroll automático - transiciones instantáneas
        // Ya no forzamos scroll hacia arriba al cambiar de página
    });

    // Función para agregar vencimiento
    function agregarVencimiento(codigo, fecha) {
        fetch('{% url "agregar-vencimiento-ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `codigo_barra=${codigo}&fecha_vencimiento=${fecha}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Éxito', data.message, 'success').then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        })
        .catch(error => {
            Swal.fire('Error', 'Error de conexión: ' + error.message, 'error');
        });
    }

    // Función para modificar vencimiento del producto
    function modificarVencimientoProducto(codigo, fecha) {
        fetch('{% url "modificar-vencimiento-producto-ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `codigo_barra=${codigo}&nueva_fecha=${fecha}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Éxito', data.message, 'success').then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        })
        .catch(error => {
            Swal.fire('Error', 'Error de conexión: ' + error.message, 'error');
        });
    }

    // Función para modificar vencimiento del lote
    function modificarVencimientoLote(codigo, numeroLote, fecha) {
        fetch('{% url "modificar-vencimiento-lote-ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `codigo_barra=${codigo}&numero_lote=${numeroLote}&nueva_fecha=${fecha}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Éxito', data.message, 'success').then(() => {
                    $('#modalModificarLote').modal('hide');
                    cargarLotes(codigo); // Recargar los lotes
                    actualizarFilaProducto(codigo); // NUEVO: Actualizar la fila principal
                });
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        })
        .catch(error => {
            Swal.fire('Error', 'Error de conexión: ' + error.message, 'error');
        });
    }

    // Función para cargar lotes con diseño de cards sin scroll horizontal
    function cargarLotes(codigo) {
        fetch('{% url "obtener-lotes-producto-ajax" %}?codigo_barra=' + codigo)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const listaLotes = document.getElementById('listaLotes');
                if (data.lotes.length === 0) {
                    listaLotes.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No hay lotes disponibles</h6>
                            <p class="text-muted mb-0">Este producto no tiene lotes registrados.</p>
                        </div>
                    `;
                } else {
                    // Calcular totales
                    const totalLotes = data.lotes.length;
                    const stockTotal = data.lotes.reduce((sum, lote) => sum + lote.stock, 0);
                    
                    let html = `
                        <!-- Resumen de Lotes -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-cubes fa-2x mb-2"></i>
                                        <h5 class="card-title mb-0">${totalLotes}</h5>
                                        <small>Total Lotes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-boxes fa-2x mb-2"></i>
                                        <h5 class="card-title mb-0">${stockTotal}</h5>
                                        <small>Stock Total</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cards de Lotes -->
                        <div class="row g-2">
                    `;
                    
                    data.lotes.forEach((lote, index) => {
                        const stockClass = lote.stock === 0 ? 'danger' : (lote.stock <= 10 ? 'warning' : 'success');
                        const estadoIcon = getEstadoIcon(lote.estado);
                        const estadoClass = getEstadoClass(lote.estado);
                        
                        html += `
                            <div class="col-md-6 col-lg-4">
                                <div class="card lote-card h-100 border-0 shadow-sm" style="animation-delay: ${index * 0.1}s;">
                                    <div class="card-header bg-gradient-primary text-white py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">
                                                <i class="fas fa-tag me-1"></i>
                                                Lote #${lote.numero_lote}
                                            </span>
                                            <span class="badge bg-white text-primary">
                                                <i class="fas fa-cubes me-1"></i>
                                                ${lote.stock}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Vencimiento
                                            </small>
                                            <div class="fw-bold text-dark">${lote.fecha_vencimiento_display}</div>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge ${estadoClass} w-100 py-2">
                                                ${estadoIcon}
                                                ${lote.estado}
                                            </span>
                                        </div>
                                        <button type="button" 
                                                class="btn btn-outline-info btn-sm w-100" 
                                                onclick="abrirModalModificarLote('${codigo}', '${lote.numero_lote}', '${lote.fecha_vencimiento}')"
                                                title="Modificar fecha de vencimiento">
                                            <i class="fas fa-edit me-1"></i> 
                                            Modificar Vencimiento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                        </div>
                    `;
                    listaLotes.innerHTML = html;
                    
                    // Animar las cards
                    animarCards();
                }
            } else {
                document.getElementById('listaLotes').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h6 class="text-danger">Error al cargar los lotes</h6>
                        <p class="text-muted">${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('listaLotes').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-wifi fa-3x text-danger mb-3"></i>
                    <h6 class="text-danger">Error de conexión</h6>
                    <p class="text-muted">${error.message}</p>
                </div>
            `;
        });
    }

    // Función auxiliar para obtener iconos de estado
    function getEstadoIcon(estado) {
        const iconos = {
            'vencido': '<i class="fas fa-times-circle me-1"></i>',
            'vence hoy': '<i class="fas fa-exclamation-triangle me-1"></i>',
            'crítico': '<i class="fas fa-exclamation-triangle me-1"></i>',
            'critico': '<i class="fas fa-exclamation-triangle me-1"></i>',
            'precaución': '<i class="fas fa-clock me-1"></i>',
            'precaucion': '<i class="fas fa-clock me-1"></i>',
            'normal': '<i class="fas fa-check-circle me-1"></i>',
            'bueno': '<i class="fas fa-check-circle me-1"></i>'
        };
        return iconos[estado.toLowerCase()] || '<i class="fas fa-question-circle me-1"></i>';
    }

    // Función auxiliar para obtener clases de estado para badges
    function getEstadoClass(estado) {
        const clases = {
            'vencido': 'bg-danger',
            'vence hoy': 'bg-warning text-dark',
            'crítico': 'bg-warning text-dark',
            'critico': 'bg-warning text-dark',
            'precaución': 'bg-info',
            'precaucion': 'bg-info',
            'normal': 'bg-success',
            'bueno': 'bg-success'
        };
        return clases[estado.toLowerCase()] || 'bg-secondary';
    }

    // Función para animar las cards de lotes con transiciones más suaves
    function animarCards() {
        const cards = document.querySelectorAll('.lote-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('show');
            }, index * 50); // Reducido el delay para transición más rápida
        });
    }

    // Función para abrir modal modificar lote
    function abrirModalModificarLote(codigo, numeroLote, fechaActual) {
        $('#codigoBarraLote').val(codigo);
        $('#numeroLoteModificar').val(numeroLote);
        $('#loteModificar').text('Lote #' + numeroLote);
        $('#fechaVencimientoLote').val(fechaActual);
        $('#modalModificarLote').modal('show');
    }

    // NUEVA: Función para actualizar la fila del producto automáticamente
    function actualizarFilaProducto(codigo) {
        // Buscar la fila del producto en la tabla principal
        const fila = document.querySelector(`tr[data-codigo="${codigo}"]`);
        if (!fila) {
            // Si no encuentra la fila por data-codigo, buscar por contenido
            const filas = document.querySelectorAll('tbody tr');
            for (let f of filas) {
                const codigoCell = f.querySelector('td:first-child');
                if (codigoCell && codigoCell.textContent.trim() === codigo) {
                    actualizarDatosProducto(f, codigo);
                    return;
                }
            }
            console.log('No se encontró la fila del producto:', codigo);
            return;
        }
        
        actualizarDatosProducto(fila, codigo);
    }
    
    function actualizarDatosProducto(fila, codigo) {
        // Obtener datos actualizados del producto
        fetch('{% url "obtener-datos-producto-ajax" %}?codigo_barra=' + codigo)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const producto = data.producto;
                console.log('🔍 Datos recibidos del servidor:', producto);
                
                // Función para mapear estados a clases CSS
                function getClaseEstado(estado) {
                    const mapeoEstados = {
                        'vencido': 'estado-vencido',
                        'vence hoy': 'estado-critico',
                        'crítico': 'estado-critico',
                        'critico': 'estado-critico',
                        'precaución': 'estado-proximo',
                        'precaucion': 'estado-proximo',
                        'normal': 'estado-bueno',
                        'sin vencimiento': 'badge-secondary'
                    };
                    return mapeoEstados[estado.toLowerCase()] || 'badge-secondary';
                }
                
                // CORRECCIÓN: Actualizar estado de vencimiento en la columna CORRECTA (5ta columna)
                const estadoCell = fila.querySelector('td:nth-child(5)'); // Columna "Estado Vencimiento"
                if (estadoCell) {
                    const claseEstado = getClaseEstado(producto.estado_vencimiento);
                    estadoCell.innerHTML = `<span class="badge ${claseEstado}">${producto.estado_vencimiento}</span>`;
                    console.log('✅ Estado actualizado en columna 5:', producto.estado_vencimiento);
                }
                
                // CORRECCIÓN: Actualizar fecha de vencimiento en la columna CORRECTA (6ta columna)
                const fechaCell = fila.querySelector('td:nth-child(6)'); // Columna "Fecha Vencimiento"
                if (fechaCell) {
                    fechaCell.innerHTML = producto.proximo_vencimiento ? 
                        producto.proximo_vencimiento_display : 
                        '<span class="text-muted">Sin fecha</span>';
                    console.log('✅ Fecha actualizada en columna 6:', producto.proximo_vencimiento_display);
                }
                
                // Actualizar cantidad de lotes (7ma columna)
                const lotesCell = fila.querySelector('td:nth-child(7)'); // Columna "Lotes"
                if (lotesCell) {
                    lotesCell.innerHTML = `<span class="badge badge-primary">${producto.total_lotes} lote${producto.total_lotes !== 1 ? 's' : ''}</span>`;
                }
                
                // Actualizar botones de acción si es necesario
                const accionesCell = fila.querySelector('td:last-child');
                if (accionesCell && producto.total_lotes > 0) {
                    // Si ahora tiene lotes, ocultar botón modificar y mostrar mensaje
                    const btnModificar = accionesCell.querySelector('.btn-warning');
                    if (btnModificar) {
                        btnModificar.style.display = 'none';
                        // Agregar mensaje informativo si no existe
                        if (!accionesCell.querySelector('.badge.bg-info')) {
                            const mensaje = document.createElement('span');
                            mensaje.className = 'badge bg-info text-dark me-2';
                            mensaje.innerHTML = '<i class="fas fa-info-circle"></i> Modificar por lotes';
                            accionesCell.insertBefore(mensaje, accionesCell.firstChild);
                        }
                    }
                }
                
                console.log('✅ Fila actualizada correctamente para producto:', codigo);
                console.log('📊 Resumen de actualización:', {
                    estado: producto.estado_vencimiento,
                    fecha: producto.proximo_vencimiento_display,
                    lotes: producto.total_lotes
                });
            } else {
                console.error('Error al obtener datos del producto:', data.error);
            }
        })
        .catch(error => {
            console.error('Error de conexión al actualizar fila:', error);
        });
    }

    // Función para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funciones para transiciones de página más directas y rápidas
    function initPageTransitions() {
        const body = document.body;
        body.classList.add('page-transition');
        
        // Aplicar fade-in inicial muy suave
        setTimeout(() => {
            body.classList.add('page-fade-in');
        }, 50);
        
        // Navegación directa sin interceptar - más rápida
        // Ya no interceptamos los clics para permitir navegación nativa
    }

    function smoothPageTransition(url) {
        // Transición mínima sin scroll forzado
        const body = document.body;
        body.classList.add('page-fade-out');
        
        setTimeout(() => {
            window.location.href = url;
        }, 100); // Reducido a 100ms para cambio más rápido
    }

    // Mejorar la experiencia del modal de lotes
    function enhanceModalExperience() {
        const modalLotes = document.getElementById('modalLotes');
        if (modalLotes) {
            modalLotes.addEventListener('shown.bs.modal', function () {
                // Animar cards cuando el modal se muestra
                setTimeout(animarCards, 100);
            });
            
            modalLotes.addEventListener('hidden.bs.modal', function () {
                // Limpiar animaciones cuando se cierra
                const cards = document.querySelectorAll('.lote-card');
                cards.forEach(card => {
                    card.classList.remove('show');
                });
            });
        }
    }

    // Inicializar mejoras con navegación directa y rápida
    document.addEventListener('DOMContentLoaded', function() {
        // Solo inicializar transiciones mínimas
        initPageTransitions();
        enhanceModalExperience();
        
        // Aplicar animaciones suaves solo a elementos de la página actual
        const elements = document.querySelectorAll('.fade-in-up');
        elements.forEach((element, index) => {
            element.style.animationDelay = `${index * 0.05}s`; // Más rápido
        });
        
        // Permitir navegación nativa sin interceptar para mayor velocidad
    });
</script>
{% endblock %}
